<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🖕 CODEX Security Verification</title>
<link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
<style>
    body {
        font-family: 'Fira Code', monospace;
        background: #0d0d0d;
        color: #00ff99;
        min-height:100vh;
        display:flex;
        justify-content:center;
        align-items:flex-start;
        flex-direction:column;
        overflow-x:hidden;
        padding: 20px;
    }
    #matrix-canvas {
        position:fixed;
        top:0; left:0;
        width:100%;
        height:100%;
        z-index:-1;
    }
    .tool-section {
        background: rgba(0,0,0,0.75);
        border: 2px solid #00ff99;
        border-radius: 12px;
        padding: 30px 40px;
        margin: 50px auto;
        max-width: 450px;
        box-shadow: 0 0 30px rgba(0,255,153,0.3);
        text-align: center;
    }
    .section-title {
        font-size: 28px;
        font-weight: 700;
        color: #00ff99;
        position: relative;
        display: inline-block;
        margin-bottom: 25px;
    }
    .section-title::after {
        content: "";
        position: absolute;
        width: 100%;
        height: 4px;
        bottom: -5px;
        left: 0;
        background: linear-gradient(90deg, #ff00ff, #00ffff);
        border-radius: 2px;
    }
    .glitch-text {
        position: relative;
        color: #00ff99;
    }
    .glitch-text::before,
    .glitch-text::after {
        content: attr(data-text);
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0.8;
    }
    .glitch-text::before {
        left: 2px;
        text-shadow: -2px 0 #f0f;
        animation: glitchTop 2s infinite linear alternate-reverse;
    }
    .glitch-text::after {
        left: -2px;
        text-shadow: -2px 0 #0ff;
        animation: glitchBottom 2s infinite linear alternate-reverse;
    }
    @keyframes glitchTop {
        0% { clip: rect(0,9999px,0,0); }
        5% { clip: rect(0,9999px,5px,0); }
        10% { clip: rect(0,9999px,0,0); }
        15% { clip: rect(0,9999px,5px,0); }
        20% { clip: rect(0,9999px,0,0); }
        25% { clip: rect(0,9999px,5px,0); }
        30% { clip: rect(0,9999px,0,0); }
        100% { clip: rect(0,9999px,0,0); }
    }
    @keyframes glitchBottom {
        0% { clip: rect(5px,9999px,9999px,0); }
        5% { clip: rect(5px,9999px,9999px,0); }
        10% { clip: rect(5px,9999px,9999px,0); }
        15% { clip: rect(0,9999px,9999px,0); }
        20% { clip: rect(5px,9999px,9999px,0); }
        25% { clip: rect(0,9999px,9999px,0); }
        30% { clip: rect(5px,9999px,9999px,0); }
        100% { clip: rect(5px,9999px,9999px,0); }
    }
    .input-group { margin-bottom: 20px; text-align:right; }
    label { display:block; margin-bottom:8px; font-weight:bold; }
    input {
        width:100%;
        padding:12px;
        border:1px solid #00ff99;
        border-radius:6px;
        background: rgba(0,0,0,0.85);
        color:#00ff99;
        font-size:14px;
    }
    input:focus { outline:none; border-color:#ff00ff; box-shadow:0 0 12px rgba(255,0,255,0.3); }
    .verify-btn {
        width:100%;
        padding:15px;
        font-weight:bold;
        font-size:16px;
        text-transform:uppercase;
        border:none;
        border-radius:6px;
        background: linear-gradient(90deg,#ff00ff,#00ffff);
        color:#000;
        cursor:pointer;
        transition: all 0.3s;
    }
    .verify-btn:hover {
        transform:translateY(-2px);
        box-shadow:0 5px 20px rgba(0,255,255,0.4);
    }
    .status-message { margin-top:12px; font-weight:bold; display:block; }
    .error { color:#ff00ff; }
    .success { color:#00ffff; }
</style>
</head>
<body>

<section class="tool-section" id="challenge-section">
    <h2 class="section-title glitch-text" data-text="CODEX Security Challenge">CODEX Security Challenge</h2>
    <div class="input-group">
        <label for="answer-input">حل المعادلة:</label>
        <input type="number" id="answer-input" placeholder="أدخل الإجابة هنا..." />
    </div>
    <button id="verify-btn" class="verify-btn">تحقق</button>
    <div id="challenge-message" class="status-message"></div>
</section>

<canvas id="matrix-canvas"></canvas>

<script>
    // Matrix Rain
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%'.split('');
    const fontSize = 16;
    const columns = canvas.width / fontSize;
    const drops = Array(Math.floor(columns)).fill(1);
    function drawMatrix() {
        ctx.fillStyle = 'rgba(0,0,0,0.05)';
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#0F0';
        ctx.font = fontSize + 'px monospace';
        for(let i=0;i<drops.length;i++){
            const text = letters[Math.floor(Math.random()*letters.length)];
            ctx.fillText(text,i*fontSize,drops[i]*fontSize);
            if(drops[i]*fontSize>canvas.height && Math.random()>0.975) drops[i]=0;
            drops[i]++;
        }
    }
    setInterval(drawMatrix,50);
    window.addEventListener('resize',()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;});

    // Challenge Logic
    const verifyBtn = document.getElementById('verify-btn');
    const answerInput = document.getElementById('answer-input');
    const messageDiv = document.getElementById('challenge-message');
    let question = "";
    let attempts = 0;
    const maxAttempts = 3;
    const userAgent = navigator.userAgent;

    async function loadChallenge(){
        try {
            const res = await fetch('/api/security/generate-challenge');
            if(res.ok){
                const data = await res.json();
                question = data.question;
                answerInput.value="";
                messageDiv.style.display="none";
                verifyBtn.disabled=false;
                document.querySelector('#challenge-section label').textContent = `حل المعادلة: ${question}`;
            }else{
                document.querySelector('#challenge-section label').textContent = "حدث خطأ في تحميل السؤال.";
                verifyBtn.disabled=true;
            }
        } catch {
            document.querySelector('#challenge-section label').textContent = "فشل في تحميل السؤال.";
            verifyBtn.disabled=true;
        }
    }

    async function verifyAnswer(){
        let answer = answerInput.value.trim();
        if(answer===""){ showMessage("الرجاء إدخال الإجابة", true); return; }
        verifyBtn.disabled=true;
        try{
            const res = await fetch('/api/security/verify-human',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({answer, user_agent:userAgent, attempts})
            });
            const data = await res.json();
            if(res.ok && data.success){
                showMessage(data.message, false);
                setTimeout(()=>{ window.location.href='/admin/login'; }, 1500);
            }else{
                attempts++;
                if(attempts>=maxAttempts){
                    showMessage("تجاوزت عدد المحاولات المسموح به. سيتم حظرك مؤقتًا.", true);
                    verifyBtn.disabled=true;
                    setTimeout(()=>{ window.location.href='/security/blocked'; },3000);
                }else{
                    showMessage(data.message||"الإجابة غير صحيحة، حاول مجددًا.", true);
                    await loadChallenge();
                }
            }
        }catch{
            showMessage("حدث خطأ أثناء التحقق. حاول لاحقًا.", true);
        }finally{ verifyBtn.disabled=false; }
    }

    function showMessage(msg,isError){
        messageDiv.textContent = msg;
        messageDiv.className = 'status-message '+(isError?'error':'success');
        messageDiv.style.display='block';
    }

    verifyBtn.addEventListener('click', verifyAnswer);
    answerInput.addEventListener('keypress',(e)=>{if(e.key==='Enter') verifyAnswer();});
    loadChallenge();
</script>

</body>
</html>
